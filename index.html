<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>corewatcher</title>
  <meta name="theme-color" content="#050508" />
  <meta name="description" content="corewatcher portal ‚Äî private homelab access via Tailscale + live server heartbeat." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #050508;
      --surface: rgba(255,255,255,.025);
      --surface-hover: rgba(255,255,255,.045);
      --border: rgba(255,255,255,.06);
      --border-bright: rgba(255,255,255,.12);
      --text: #e8e8f0;
      --text-dim: rgba(232,232,240,.5);
      --text-mid: rgba(232,232,240,.7);

      --green: #00ff9d;
      --green-dim: rgba(0,255,157,.08);
      --green-mid: rgba(0,255,157,.2);
      --red: #ff3366;
      --red-dim: rgba(255,51,102,.08);
      --red-mid: rgba(255,51,102,.2);
      --amber: #ffaa00;

      --accent: #00ff9d;
      --accent2: #7c5cff;
      --accent3: #ff3366;

      --mono: 'JetBrains Mono', ui-monospace, monospace;
      --sans: 'Outfit', sans-serif;

      --radius: 16px;
      --radius-sm: 10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; }

    body {
      min-height: 100%;
      font-family: var(--sans);
      color: var(--text);
      background: var(--bg);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* === BACKGROUND === */
    .atmosphere {
      position: fixed; inset: 0;
      pointer-events: none; z-index: 0;
    }
    .atmosphere::before {
      content: "";
      position: absolute;
      width: 800px; height: 800px;
      top: -300px; left: -200px;
      background: radial-gradient(circle, rgba(0,255,157,.06) 0%, transparent 70%);
      animation: drift1 20s ease-in-out infinite;
    }
    .atmosphere::after {
      content: "";
      position: absolute;
      width: 600px; height: 600px;
      bottom: -200px; right: -100px;
      background: radial-gradient(circle, rgba(124,92,255,.05) 0%, transparent 70%);
      animation: drift2 25s ease-in-out infinite;
    }
    @keyframes drift1 {
      0%, 100% { transform: translate(0,0) scale(1); }
      33% { transform: translate(80px,40px) scale(1.1); }
      66% { transform: translate(-40px,80px) scale(.95); }
    }
    @keyframes drift2 {
      0%, 100% { transform: translate(0,0) scale(1); }
      50% { transform: translate(-60px,-40px) scale(1.08); }
    }

    #particles {
      position: fixed; inset: 0;
      pointer-events: none; z-index: 0;
    }

    .grid-bg {
      position: fixed; inset: 0;
      pointer-events: none;
      opacity: .025;
      background-image:
        linear-gradient(rgba(255,255,255,.15) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.15) 1px, transparent 1px);
      background-size: 60px 60px;
      mask-image: radial-gradient(ellipse 70% 60% at 50% 40%, black 20%, transparent 70%);
    }

    .scanline {
      position: fixed; inset: 0;
      pointer-events: none; z-index: 9999;
      opacity: .018;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,.08) 2px, rgba(255,255,255,.08) 4px);
    }

    /* === LAYOUT === */
    .container {
      position: relative; z-index: 1;
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 20px 60px;
    }

    /* === HEADER === */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 40px;
      animation: fadeUp .6s ease both;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-mark {
      width: 48px; height: 48px;
      border-radius: 14px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface);
      border: 1px solid var(--border-bright);
      overflow: hidden;
      cursor: pointer;
      transition: all .2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .logo-mark:hover {
      border-color: var(--green-mid);
      background: var(--green-dim);
    }
    .logo-mark:active { transform: scale(.95); }
    .logo-mark::before {
      content: "";
      position: absolute;
      width: 20px; height: 20px;
      border-radius: 50%;
      background: var(--accent);
      filter: blur(12px);
      opacity: .4;
      animation: logoPulse 3s ease-in-out infinite;
    }
    .logo-mark::after {
      content: "‚¨°";
      font-size: 22px;
      color: var(--text);
      opacity: .9;
      position: relative; z-index: 1;
    }
    @keyframes logoPulse {
      0%, 100% { opacity: .3; transform: scale(.8); }
      50% { opacity: .6; transform: scale(1.2); }
    }

    .brand-text h1 {
      font-family: var(--mono);
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: lowercase;
    }
    .brand-text h1 span { color: var(--accent); }
    .brand-sub {
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--mono);
      letter-spacing: .5px;
      margin-top: 2px;
    }

    /* Status chip */
    .status-chip {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--border);
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 500;
      letter-spacing: .5px;
      color: var(--text-mid);
      transition: all .3s ease;
      user-select: none;
      white-space: nowrap;
    }
    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--amber);
      transition: all .3s ease;
      position: relative;
      flex-shrink: 0;
    }
    .status-dot::after {
      content: "";
      position: absolute; inset: -4px;
      border-radius: 50%;
      border: 1.5px solid currentColor;
      opacity: 0;
    }

    .status-chip.online {
      border-color: var(--green-mid);
      background: var(--green-dim);
      color: var(--green);
    }
    .status-chip.online .status-dot {
      background: var(--green);
      box-shadow: 0 0 12px rgba(0,255,157,.4);
    }
    .status-chip.online .status-dot::after {
      border-color: var(--green);
      animation: ringPulse 2s ease-in-out infinite;
      opacity: 1;
    }
    .status-chip.offline {
      border-color: var(--red-mid);
      background: var(--red-dim);
      color: var(--red);
    }
    .status-chip.offline .status-dot {
      background: var(--red);
      box-shadow: 0 0 12px rgba(255,51,102,.4);
    }
    .status-chip.offline .status-dot::after {
      border-color: var(--red);
      animation: ringPulse 1.4s ease-in-out infinite;
      opacity: 1;
    }
    @keyframes ringPulse {
      0% { transform: scale(1); opacity: .6; }
      100% { transform: scale(2.5); opacity: 0; }
    }

    /* === BENTO GRID === */
    .bento {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      animation: fadeUp .6s ease .15s both;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      position: relative;
      overflow: hidden;
      transition: border-color .25s ease, background .25s ease;
    }
    .card:hover {
      border-color: var(--border-bright);
      background: var(--surface-hover);
    }
    .card::before {
      content: "";
      position: absolute;
      top: 0; left: 20%; right: 20%;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
    }

    .card.full { grid-column: 1 / -1; }
    .card.accent-green::after {
      content: "";
      position: absolute;
      top: -80px; right: -80px;
      width: 200px; height: 200px;
      background: radial-gradient(circle, var(--green-dim) 0%, transparent 70%);
      pointer-events: none;
    }
    .card.accent-purple::after {
      content: "";
      position: absolute;
      bottom: -80px; left: -80px;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(124,92,255,.06) 0%, transparent 70%);
      pointer-events: none;
    }

    .card-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 16px;
    }
    .card-label .icon { font-size: 14px; opacity: .6; }

    .card h2 {
      font-family: var(--sans);
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -.3px;
    }

    .card-desc {
      color: var(--text-dim);
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    /* === BUTTONS === */
    .actions { display: flex; flex-wrap: wrap; gap: 10px; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: var(--radius-sm);
      text-decoration: none;
      font-family: var(--mono);
      font-size: 13px;
      font-weight: 500;
      letter-spacing: .3px;
      color: var(--bg);
      background: var(--accent);
      border: none;
      cursor: pointer;
      transition: all .15s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: "";
      position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,.15), transparent);
      opacity: 0;
      transition: opacity .15s ease;
    }
    .btn:hover::before { opacity: 1; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 8px 30px rgba(0,255,157,.2); }
    .btn:active { transform: translateY(0); }

    .btn.ghost {
      background: transparent;
      color: var(--text-mid);
      border: 1px solid var(--border-bright);
    }
    .btn.ghost:hover {
      background: var(--surface-hover);
      color: var(--text);
      box-shadow: none;
      border-color: rgba(255,255,255,.2);
    }
    .btn.ghost::before { display: none; }
    .btn.disabled { opacity: .3; pointer-events: none; filter: grayscale(.5); }

    /* === STEPS (FIXED) === */
    .steps-list {
      list-style: none;
      counter-reset: step;
      margin-top: 20px;
    }
    .steps-list li {
      counter-increment: step;
      padding: 16px 0 16px 46px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      color: var(--text-mid);
      line-height: 1.7;
      position: relative;
    }
    .steps-list li:last-child { border-bottom: none; }
    .steps-list li::before {
      content: counter(step, decimal-leading-zero);
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 700;
      color: var(--accent);
      opacity: .7;
      width: 28px; height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: var(--green-dim);
      position: absolute;
      left: 0;
      top: 16px;
    }

    .code {
      font-family: var(--mono);
      font-size: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 6px;
      color: var(--accent);
      white-space: nowrap;
      display: inline;
    }
    @media (max-width: 500px) {
      .code { white-space: normal; word-break: break-all; }
    }

    /* === HEALTH PANEL === */
    .health-grid { display: grid; gap: 0; margin-top: 4px; }
    .health-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
      gap: 12px;
    }
    .health-row:last-child { border-bottom: none; }
    .health-key {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-dim);
      letter-spacing: .5px;
      text-transform: uppercase;
      flex-shrink: 0;
    }
    .health-val {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text);
      text-align: right;
      word-break: break-word;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 600;
    }
    .status-badge.up {
      background: var(--green-dim);
      color: var(--green);
      border: 1px solid var(--green-mid);
    }
    .status-badge.down {
      background: var(--red-dim);
      color: var(--red);
      border: 1px solid var(--red-mid);
    }

    .hint-text {
      margin-top: 16px;
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--mono);
      padding: 10px 14px;
      background: rgba(255,255,255,.02);
      border-radius: var(--radius-sm);
      border-left: 2px solid var(--border-bright);
      line-height: 1.5;
    }

    .card-footer {
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-dim);
      gap: 8px;
      flex-wrap: wrap;
    }
    .json-link {
      color: var(--text-dim);
      text-decoration: none;
      padding: 4px 10px;
      border-radius: 6px;
      background: var(--surface);
      border: 1px solid var(--border);
      transition: all .2s ease;
      flex-shrink: 0;
    }
    .json-link:hover {
      color: var(--text);
      border-color: var(--border-bright);
      background: var(--surface-hover);
    }

    /* === TERMINAL EASTER EGG === */
    .terminal-overlay {
      position: fixed; inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,.85);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
    }
    .terminal-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .terminal {
      width: min(620px, 100%);
      max-height: 80vh;
      background: #0a0a10;
      border: 1px solid var(--green-mid);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 0 80px rgba(0,255,157,.06), 0 40px 80px rgba(0,0,0,.5);
      transform: scale(.95) translateY(10px);
      transition: transform .3s ease;
    }
    .terminal-overlay.open .terminal {
      transform: scale(1) translateY(0);
    }

    .terminal-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 18px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid var(--border);
    }
    .terminal-dot { width: 12px; height: 12px; border-radius: 50%; }
    .terminal-dot.r { background: #ff5f57; }
    .terminal-dot.y { background: #febc2e; }
    .terminal-dot.g { background: #28c840; }
    .terminal-title {
      flex: 1;
      text-align: center;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-dim);
      letter-spacing: .5px;
    }
    .terminal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 18px;
      padding: 0 4px;
      transition: color .2s;
      font-family: var(--mono);
    }
    .terminal-close:hover { color: var(--text); }

    .terminal-body {
      padding: 18px;
      min-height: 300px;
      max-height: calc(80vh - 50px);
      overflow-y: auto;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.7;
      color: var(--text-mid);
    }
    .terminal-body::-webkit-scrollbar { width: 4px; }
    .terminal-body::-webkit-scrollbar-track { background: transparent; }
    .terminal-body::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 4px; }

    .term-line { margin-bottom: 2px; white-space: pre-wrap; word-break: break-word; }
    .term-line.green { color: var(--green); }
    .term-line.red { color: var(--red); }
    .term-line.purple { color: var(--accent2); }
    .term-line.dim { color: var(--text-dim); }
    .term-line.amber { color: var(--amber); }
    .term-line.bold { font-weight: 700; }
    .term-line .accent { color: var(--accent); }

    .term-input-row {
      display: flex;
      align-items: center;
      gap: 0;
      margin-top: 4px;
    }
    .term-prompt {
      color: var(--accent);
      font-family: var(--mono);
      font-size: 13px;
      flex-shrink: 0;
      user-select: none;
    }
    .term-input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text);
      caret-color: var(--accent);
      padding: 0;
    }

    /* === FOOTER === */
    .site-footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-dim);
      letter-spacing: .5px;
      animation: fadeUp .6s ease .3s both;
      flex-wrap: wrap;
      gap: 8px;
    }
    .site-footer a {
      color: var(--text-dim);
      text-decoration: none;
      transition: color .2s ease;
    }
    .site-footer a:hover { color: var(--accent); }

    .easter-hint {
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(232,232,240,.12);
      text-align: center;
      margin-top: 14px;
      letter-spacing: 1px;
      transition: color .3s ease;
      cursor: default;
      user-select: none;
    }
    .easter-hint:hover { color: rgba(232,232,240,.35); }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 700px) {
      .container { padding: 24px 14px 40px; }
      .header { flex-direction: column; align-items: flex-start; gap: 14px; }
      .bento { grid-template-columns: 1fr; }
      .card.full { grid-column: 1; }
      .card { padding: 22px; }
      .card h2 { font-size: 19px; }
      .brand-text h1 { font-size: 17px; }
      .actions { flex-direction: column; }
      .btn { justify-content: center; }
      .site-footer { flex-direction: column; text-align: center; }
    }
  </style>
</head>

<body>
  <div class="atmosphere"></div>
  <canvas id="particles"></canvas>
  <div class="grid-bg"></div>
  <div class="scanline"></div>

  <div class="container">

    <header class="header">
      <div class="brand">
        <div class="logo-mark" id="logoBtn" title="click me :)"></div>
        <div class="brand-text">
          <h1>core<span>watcher</span></h1>
          <div class="brand-sub">private homelab ¬∑ tailnet only</div>
        </div>
      </div>
      <div class="status-chip" id="healthChip">
        <span class="status-dot" id="healthDot"></span>
        <span id="healthText">checking‚Ä¶</span>
      </div>
    </header>

    <div class="bento">

      <div class="card accent-green">
        <div class="card-label"><span class="icon">‚óà</span> access</div>
        <h2>Connect to the lab</h2>
        <p class="card-desc">
          All services are private and routed through Tailscale.
          Connect to the tailnet to reach the control center and internal apps.
        </p>
        <div class="actions">
          <a class="btn" href="https://login.tailscale.com/" target="_blank" rel="noopener">Tailscale login ‚Üó</a>
          <a class="btn ghost" id="homeBtn" href="https://home.corewatcher.com" target="_blank" rel="noopener">Control center</a>
          <a class="btn ghost" href="https://tailscale.com/download" target="_blank" rel="noopener">Download client</a>
        </div>
      </div>

      <div class="card accent-purple">
        <div class="card-label"><span class="icon">‚óâ</span> server health</div>
        <h2>Live status</h2>
        <p class="card-desc">Auto-updated by the server. If updates stop, assume it's unreachable.</p>
        <div class="health-grid">
          <div class="health-row">
            <span class="health-key">Status</span>
            <span class="health-val" id="statusLine">‚Äî</span>
          </div>
          <div class="health-row">
            <span class="health-key">Last seen</span>
            <span class="health-val" id="lastSeen">‚Äî</span>
          </div>
          <div class="health-row">
            <span class="health-key">Message</span>
            <span class="health-val" id="message">‚Äî</span>
          </div>
        </div>
        <div class="hint-text" id="hint"></div>
        <div class="card-footer">
          <span id="ageLine">‚Äî</span>
          <a class="json-link" href="./health.json" target="_blank" rel="noopener">health.json</a>
        </div>
      </div>

      <div class="card full">
        <div class="card-label"><span class="icon">‚ñπ</span> quick setup</div>
        <h2>Get connected in 4 steps</h2>
        <ol class="steps-list">
          <li>Install <strong>Tailscale</strong> on your device ‚Äî available for all major platforms.</li>
          <li>Sign in at <span class="code">login.tailscale.com</span> with your authorized account.</li>
          <li>Toggle Tailscale <strong>"On"</strong> to join the tailnet.</li>
          <li>Open <span class="code">home.corewatcher.com</span> to verify access to the control center.</li>
        </ol>
      </div>

    </div>

    <footer class="site-footer">
      <span>corewatcher ¬∑ homelab portal</span>
      <span>tailscale-gated ¬∑ <a href="./health.json">status feed</a></span>
    </footer>
    <div class="easter-hint">try clicking the logo</div>
  </div>

  <!-- TERMINAL -->
  <div class="terminal-overlay" id="termOverlay">
    <div class="terminal">
      <div class="terminal-bar">
        <span class="terminal-dot r"></span>
        <span class="terminal-dot y"></span>
        <span class="terminal-dot g"></span>
        <span class="terminal-title">corewatcher-sh</span>
        <button class="terminal-close" id="termClose">√ó</button>
      </div>
      <div class="terminal-body" id="termBody"></div>
    </div>
  </div>

<script>
  /* ======================== HEALTH CHECK ======================== */
  const HEALTH_URL = "./health.json?t=" + Date.now();
  const STALE_MINUTES = 6;
  const el = id => document.getElementById(id);

  function setStatus(state, text) {
    const chip = el("healthChip");
    const homeBtn = el("homeBtn");
    el("healthText").textContent = text;
    chip.className = "status-chip";
    if (state === "up") { chip.classList.add("online"); homeBtn && homeBtn.classList.remove("disabled"); }
    else if (state === "down") { chip.classList.add("offline"); homeBtn && homeBtn.classList.add("disabled"); }
  }

  function fmt(ts) { try { return new Date(ts).toLocaleString(); } catch { return ts; } }
  function minutesAgo(ts) { try { return Math.max(0, Math.floor((Date.now() - new Date(ts).getTime()) / 60000)); } catch { return null; } }

  async function loadHealth() {
    try {
      const res = await fetch(HEALTH_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("fetch failed");
      const data = await res.json();
      el("lastSeen").textContent = data.last_seen ? fmt(data.last_seen) : "‚Äî";
      el("message").textContent = data.message || "‚Äî";
      let stale = true, ageMins = null;
      if (data.last_seen) { ageMins = minutesAgo(data.last_seen); stale = ageMins === null ? true : ageMins > STALE_MINUTES; }
      const up = data.server === "up" && !stale;
      el("statusLine").innerHTML = up ? '<span class="status-badge up">‚óè online</span>' : '<span class="status-badge down">‚óè offline</span>';
      if (up) { setStatus("up", "server online"); el("hint").textContent = "Can't reach control center? Make sure Tailscale is connected."; }
      else { setStatus("down", "server offline"); el("hint").textContent = "Server unreachable ‚Äî check power, network, Docker, or scheduled maintenance."; }
      el("ageLine").textContent = ageMins === null ? "last update: unknown" : `last update: ${ageMins} min ago`;
    } catch {
      setStatus("down", "server offline");
      el("statusLine").innerHTML = '<span class="status-badge down">‚óè offline</span>';
      el("lastSeen").textContent = "‚Äî";
      el("message").textContent = "no health data available";
      el("hint").textContent = "Health feed missing ‚Äî ensure health.json exists and is reachable.";
      el("ageLine").textContent = "last update: ‚Äî";
    }
  }
  loadHealth();

  /* ======================== PARTICLES ======================== */
  (() => {
    const canvas = document.getElementById("particles");
    const ctx = canvas.getContext("2d");
    let W, H, pts = [];
    function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
    resize();
    window.addEventListener("resize", resize);
    const N = Math.min(45, Math.floor(window.innerWidth / 30));
    for (let i = 0; i < N; i++) {
      pts.push({
        x: Math.random() * W, y: Math.random() * H,
        r: Math.random() * 1.4 + .4,
        dx: (Math.random() - .5) * .22,
        dy: (Math.random() - .5) * .22,
        o: Math.random() * .25 + .05,
        c: ["0,255,157", "124,92,255", "232,232,240"][Math.floor(Math.random() * 3)]
      });
    }
    function draw() {
      ctx.clearRect(0, 0, W, H);
      for (const p of pts) {
        p.x += p.dx; p.y += p.dy;
        if (p.x < -10) p.x = W + 10; if (p.x > W + 10) p.x = -10;
        if (p.y < -10) p.y = H + 10; if (p.y > H + 10) p.y = -10;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(${p.c},${p.o})`; ctx.fill();
      }
      for (let i = 0; i < pts.length; i++) for (let j = i + 1; j < pts.length; j++) {
        const d = Math.hypot(pts[i].x - pts[j].x, pts[i].y - pts[j].y);
        if (d < 110) {
          ctx.beginPath(); ctx.moveTo(pts[i].x, pts[i].y); ctx.lineTo(pts[j].x, pts[j].y);
          ctx.strokeStyle = `rgba(255,255,255,${.018 * (1 - d / 110)})`; ctx.lineWidth = .5; ctx.stroke();
        }
      }
      requestAnimationFrame(draw);
    }
    draw();
  })();

  /* ======================== TERMINAL ======================== */
  (() => {
    const overlay = el("termOverlay");
    const body = el("termBody");
    let inputEl = null;
    let gameActive = false;

    const MOTD = [
      { t: "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó", c: "green" },
      { t: "‚ïë     corewatcher terminal v1.0.0      ‚ïë", c: "green bold" },
      { t: "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù", c: "green" },
      { t: "" },
      { t: "  welcome to the void.", c: "purple" },
      { t: "  type 'help' to see available commands.", c: "dim" },
      { t: "" },
    ];

    const QUOTES = [
      "\"Any sufficiently advanced homelab is indistinguishable from magic.\"",
      "\"It works on my machine\" ‚Äî every developer, ever",
      "\"Have you tried turning it off and on again?\" ‚Äî the IT crowd",
      "\"There's no place like 127.0.0.1\"",
      "\"sudo make me a sandwich\" ‚Äî xkcd",
      "\"It's not a bug, it's a feature\"",
      "\"Works in prod, don't touch it\" ‚Äî ancient proverb",
      "\"The cloud is just someone else's computer\"",
      "\"rm -rf / speedruns any%\" ‚Äî chaotic evil",
      "\"SEGFAULT (core dumped)\" ‚Äî the computer, probably",
      "\"There are 10 types of people...\" ‚Äî you know the rest",
      "\"DNS: it's always DNS.\" ‚Äî every sysadmin",
      "\"I don't always test my code, but when I do, I do it in production.\"",
      "\"To mass mass mass destruction!\"",
    ];

    const FORTUNES = [
      "You will mass mass mass mass mass destruct something in prod today.",
      "A container restart is in your near future.",
      "The stars align for a successful deployment... maybe.",
      "You will discover a critical typo in a config file at 2 AM.",
      "Lucky numbers: 22, 80, 443, 8080, 3000",
      "A wild segfault appears in your future. Prepare accordingly.",
      "Today is a good day to update your backups.",
      "Someone will ask you to fix their printer. Resistance is futile.",
      "Your next 'quick fix' will take 6 hours.",
      "Uptime will be achieved... after one more reboot.",
      "A mass mass mass of mass mass mass mass",
      "You will mass mass‚Äî wait, wrong script.",
    ];

    const cmds = {
      help: () => [
        { t: "available commands:", c: "green bold" }, { t: "" },
        { t: "  help          show this message" },
        { t: "  status        server status" },
        { t: "  about         about corewatcher" },
        { t: "  quote         random tech quote" },
        { t: "  fortune       your tech fortune" },
        { t: "  uptime        server uptime" },
        { t: "  ping          ping the void" },
        { t: "  traceroute    trace the route" },
        { t: "  cowsay [msg]  moo" },
        { t: "  ascii         random ascii art" },
        { t: "  clock         current time" },
        { t: "  hack          become a hacker", c: "dim" },
        { t: "  pong          play pong!", c: "green" },
        { t: "  snake         play snake!", c: "green" },
        { t: "  matrix        digital rain", c: "dim" },
        { t: "  clear         clear terminal" },
        { t: "  exit          close terminal" },
        { t: "" },
      ],
      status: () => {
        const on = el("healthChip").classList.contains("online");
        return [
          { t: `server: ${on ? "‚óè ONLINE" : "‚óè OFFLINE"}`, c: on ? "green bold" : "red bold" },
          { t: `checked: ${el("ageLine").textContent}`, c: "dim" },
        ];
      },
      about: () => [
        { t: "corewatcher", c: "green bold" },
        { t: "a private homelab portal." },
        { t: "self-hosted, dockerized, and tailscale-gated." },
        { t: "" },
        { t: "domain: corewatcher.com", c: "dim" },
        { t: "access: tailscale VPN only", c: "dim" },
        { t: "stack:  linux ¬∑ docker ¬∑ caddy ¬∑ cloudflare", c: "dim" },
        { t: "" },
      ],
      quote: () => [{ t: "" }, { t: QUOTES[Math.floor(Math.random() * QUOTES.length)], c: "purple" }, { t: "" }],
      fortune: () => [
        { t: "" },
        { t: "üîÆ your tech fortune:", c: "amber" },
        { t: "  " + FORTUNES[Math.floor(Math.random() * FORTUNES.length)], c: "purple" },
        { t: "" },
      ],
      uptime: () => {
        const d = Math.floor(Math.random() * 90) + 5, h = Math.floor(Math.random() * 24), m = Math.floor(Math.random() * 60);
        return [
          { t: ` ${String(d).padStart(3)} days ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`, c: "green" },
          { t: "  (vibes-based telemetry, not real data)", c: "dim" }
        ];
      },
      ping: () => {
        const ms = Math.floor(Math.random() * 12) + 1;
        return [
          { t: `PING corewatcher.local (100.x.x.x): 56 data bytes`, c: "dim" },
          { t: `64 bytes: icmp_seq=0 ttl=64 time=${ms}.${String(Math.floor(Math.random()*99)).padStart(2,'0')}ms`, c: "green" },
          { t: `64 bytes: icmp_seq=1 ttl=64 time=${ms+1}.${String(Math.floor(Math.random()*99)).padStart(2,'0')}ms`, c: "green" },
          { t: `64 bytes: icmp_seq=2 ttl=64 time=${ms}.${String(Math.floor(Math.random()*99)).padStart(2,'0')}ms`, c: "green" },
          { t: `--- corewatcher.local ping statistics ---`, c: "dim" },
          { t: `3 packets transmitted, 3 received, 0% packet loss` },
        ];
      },
      traceroute: () => {
        const lines = [{ t: "traceroute to corewatcher.local, 8 hops max", c: "dim" }];
        const hops = [
          "gateway.local", "isp-edge-01.net", "core-rtr-zh.backbone.net",
          "ix-zurich-01.peering.net", "cdn-edge.cloudflare.com",
          "tailscale-relay.ts.net", "mesh-node.tailnet.internal", "corewatcher.local"
        ];
        for (let i = 0; i < hops.length; i++) {
          const ms = (Math.random() * 15 + i * 2).toFixed(2);
          lines.push({ t: ` ${String(i+1).padStart(2)}  ${hops[i].padEnd(32)} ${ms} ms`, c: i === hops.length - 1 ? "green" : "" });
        }
        return lines;
      },
      clock: () => {
        const now = new Date();
        const time = now.toLocaleTimeString('en-US', { hour12: false });
        const date = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const big = time.split('').map(ch => {
          const digits = {
            '0': ['‚ïî‚ïê‚ïó','‚ïë ‚ïë','‚ïö‚ïê‚ïù'], '1': ['  ‚ïó','  ‚ïë','  ‚ïù'], '2': ['‚ïî‚ïê‚ïó','‚ïî‚ïê‚ïù','‚ïö‚ïê‚ïù'],
            '3': ['‚ïî‚ïê‚ïó','‚ïî‚ïê‚ïó','‚ïö‚ïê‚ïù'], '4': ['‚ïó ‚ïó','‚ïö‚ïê‚ï£','  ‚ïù'], '5': ['‚ïî‚ïê‚ïó','‚ïö‚ïê‚ïó','‚ïö‚ïê‚ïù'],
            '6': ['‚ïî‚ïê‚ïó','‚ï†‚ïê‚ïó','‚ïö‚ïê‚ïù'], '7': ['‚ïî‚ïê‚ïó','  ‚ïë','  ‚ïù'], '8': ['‚ïî‚ïê‚ïó','‚ï†‚ïê‚ï£','‚ïö‚ïê‚ïù'],
            '9': ['‚ïî‚ïê‚ïó','‚ïö‚ïê‚ï£','‚ïö‚ïê‚ïù'], ':': [' ¬∑ ',' ¬∑ ','   ']
          };
          return digits[ch] || ['   ','   ','   '];
        });
        const rows = [0,1,2].map(r => big.map(d => d[r]).join(' '));
        return [
          { t: "" },
          ...rows.map(r => ({ t: "  " + r, c: "green" })),
          { t: "" },
          { t: "  " + date, c: "dim" },
          { t: "" },
        ];
      },
      ascii: () => {
        const arts = [
          [
            "    ‚ï±|„ÄÅ",
            "  (ÀöÀé „ÄÇ7",
            "   |„ÄÅÀú„Äµ",
            "   „Åò„ÅóÀç,)„Éé",
            "",
            "   meow.",
          ],
          [
            "  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê",
            "  ‚îÇ ‚ñà‚ñà  ‚ñà‚ñà  ‚îÇ",
            "  ‚îÇ  ‚ñÄ‚ñà‚ñà‚ñÄ   ‚îÇ",
            "  ‚îÇ  ‚ï±  ‚ï≤   ‚îÇ",
            "  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò",
            "    ROBOT.exe",
          ],
          [
            "     .  *  .   .",
            "  *    üåç    *",
            "    .    *  .  *",
            "  *   .    .   .",
            "    .  *  .   *",
            "",
            "   lost in space.",
          ],
          [
            "   ‚†Ä‚†Ä‚†Ä‚¢Ä‚°§‚†ñ‚†í‚†õ‚†õ‚†í‚†≤‚¢§‚°Ä",
            "   ‚†Ä‚†Ä‚£¥‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚¢¶",
            "   ‚†Ä‚£∏‚†Å‚†Ä‚£†‚°¥‚†∂‚†∂‚£§‚°Ä‚†Ä‚†Ä‚†Ä‚†ò‚°Ü",
            "   ‚†Ä‚°á‚†Ä‚£º‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚°Ñ‚†Ä‚†Ä‚†Ä‚°á",
            "",
            "   the void stares back.",
          ],
          [
            "   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê",
            "   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ",
            "   ‚îÇ  ‚îÇ  01001000  ‚îÇ  ‚îÇ",
            "   ‚îÇ  ‚îÇ  01101001  ‚îÇ  ‚îÇ",
            "   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ",
            "   ‚îÇ   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ",
            "   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò",
            "",
            "   it says 'Hi'.",
          ],
        ];
        const art = arts[Math.floor(Math.random() * arts.length)];
        return [{ t: "" }, ...art.map(t => ({ t, c: "green" })), { t: "" }];
      },
      hack: () => {
        const lines = [{ t: "" }, { t: "INITIATING HACK SEQUENCE...", c: "red bold" }, { t: "" }];
        const msgs = [
          "‚ñì bypassing mainframe firewall...",
          "‚ñì cracking 256-bit encryption... (lol)",
          "‚ñì downloading the internet...",
          "‚ñì hacking the gibson...",
          "‚ñì inserting memes into database...",
          "‚ñì reticulating splines...",
          "‚ñì reversing the polarity...",
          "‚ñì accessing mainframe...",
          "‚ñì decrypting passwords: ******** ‚Üí hunter2",
        ];
        for (let i = 0; i < 6; i++) {
          lines.push({ t: "  " + msgs[Math.floor(Math.random() * msgs.length)], c: "green" });
        }
        lines.push({ t: "" });
        lines.push({ t: "  ACCESS GRANTED", c: "green bold" });
        lines.push({ t: "  just kidding. you're already on the tailnet.", c: "dim" });
        lines.push({ t: "" });
        return lines;
      },
      pong: () => { startPong(); return "GAME"; },
      snake: () => { startSnake(); return "GAME"; },
      matrix: () => { startMatrix(); return [{ t: "entering the matrix... (click to exit)", c: "green" }]; },
      clear: () => "CLEAR",
      exit: () => "EXIT",
    };

    /* cowsay is special ‚Äî takes arguments */
    function cowsay(msg) {
      if (!msg) msg = "moo";
      const top = " " + "_".repeat(msg.length + 2);
      const mid = `< ${msg} >`;
      const bot = " " + "‚îÄ".repeat(msg.length + 2);
      return [
        { t: "" },
        { t: top },
        { t: mid, c: "green bold" },
        { t: bot },
        { t: "        \\   ^__^" },
        { t: "         \\  (oo)\\_______" },
        { t: "            (__)\\       )\\/\\" },
        { t: "                ||----w |" },
        { t: "                ||     ||" },
        { t: "" },
      ];
    }

    function addLines(lines) {
      for (const l of lines) {
        const d = document.createElement("div");
        d.className = "term-line" + (l.c ? " " + l.c : "");
        d.textContent = l.t;
        body.insertBefore(d, body.lastElementChild);
      }
      body.scrollTop = body.scrollHeight;
    }

    function prompt() {
      if (gameActive) return;
      const row = document.createElement("div");
      row.className = "term-input-row";
      row.innerHTML = `<span class="term-prompt">‚ùØ&nbsp;</span><input class="term-input" type="text" spellcheck="false" autocomplete="off" autocapitalize="off">`;
      body.appendChild(row);
      inputEl = row.querySelector(".term-input");
      inputEl.focus();
      inputEl.addEventListener("keydown", onKey);
      body.scrollTop = body.scrollHeight;
    }

    function onKey(e) {
      if (e.key !== "Enter") return;
      const raw = inputEl.value.trim();
      const val = raw.toLowerCase();
      inputEl.removeEventListener("keydown", onKey);
      inputEl.disabled = true;

      const line = document.createElement("div");
      line.className = "term-line";
      line.innerHTML = `<span class="accent">‚ùØ</span> ${raw || " "}`;
      inputEl.parentElement.replaceWith(line);

      if (!val) { prompt(); return; }

      /* cowsay with arguments */
      if (val.startsWith("cowsay")) {
        const msg = raw.slice(6).trim();
        addLines(cowsay(msg));
        prompt();
        return;
      }

      /* sudo easter egg */
      if (val.startsWith("sudo")) {
        addLines([{ t: "nice try. you're not root here.", c: "red" }]);
        prompt();
        return;
      }

      /* rm -rf easter egg */
      if (val.includes("rm -rf") || val.includes("rm -fr")) {
        addLines([
          { t: "" },
          { t: "üö® NICE TRY üö®", c: "red bold" },
          { t: "this terminal is read-only, you menace.", c: "red" },
          { t: "" },
        ]);
        prompt();
        return;
      }

      const fn = cmds[val];
      if (fn) {
        const r = fn();
        if (r === "CLEAR") { body.innerHTML = ""; prompt(); return; }
        if (r === "EXIT") { closeTerm(); return; }
        if (r === "GAME") return; /* game handles its own prompt */
        addLines(r);
      } else {
        addLines([{ t: `command not found: ${val}. try 'help'.`, c: "red" }]);
      }
      prompt();
    }

    function openTerm() { overlay.classList.add("open"); body.innerHTML = ""; gameActive = false; addLines(MOTD); prompt(); }
    function closeTerm() { overlay.classList.remove("open"); stopMatrix(); gameActive = false; }

    el("logoBtn").addEventListener("click", openTerm);
    el("termClose").addEventListener("click", closeTerm);
    overlay.addEventListener("click", e => { if (e.target === overlay) closeTerm(); });
    document.addEventListener("keydown", e => { if (e.key === "Escape" && overlay.classList.contains("open")) closeTerm(); });

    /* ======================== PONG ======================== */
    function startPong() {
      gameActive = true;
      addLines([
        { t: "" },
        { t: "üèì PONG ‚Äî first to 5 wins!", c: "green bold" },
        { t: "  controls: W/S or ‚Üë/‚Üì to move", c: "dim" },
        { t: "  press Q to quit", c: "dim" },
        { t: "" },
      ]);

      const gameCanvas = document.createElement("canvas");
      gameCanvas.width = 400; gameCanvas.height = 220;
      gameCanvas.style.cssText = "display:block;margin:8px auto;border:1px solid rgba(0,255,157,.3);border-radius:8px;background:#0a0a10;max-width:100%;";
      body.appendChild(gameCanvas);
      body.scrollTop = body.scrollHeight;

      const gc = gameCanvas.getContext("2d");
      const W = 400, H = 220, PAD_H = 50, PAD_W = 6, BALL = 5;
      let p1y = H/2 - PAD_H/2, p2y = H/2 - PAD_H/2;
      let bx = W/2, by = H/2, bdx = 3, bdy = 2;
      let s1 = 0, s2 = 0;
      const keys = {};
      const MAX_SCORE = 5;

      function keyDown(e) { keys[e.key] = true; if(['w','s','ArrowUp','ArrowDown','q'].includes(e.key)) e.preventDefault(); }
      function keyUp(e) { keys[e.key] = false; }
      document.addEventListener("keydown", keyDown);
      document.addEventListener("keyup", keyUp);

      function tick() {
        /* player input */
        if (keys['w'] || keys['ArrowUp']) p1y = Math.max(0, p1y - 4);
        if (keys['s'] || keys['ArrowDown']) p1y = Math.min(H - PAD_H, p1y + 4);

        /* quit */
        if (keys['q']) { endPong("you quit. gg."); return; }

        /* AI */
        const aiCenter = p2y + PAD_H / 2;
        if (aiCenter < by - 10) p2y += 2.8;
        else if (aiCenter > by + 10) p2y -= 2.8;
        p2y = Math.max(0, Math.min(H - PAD_H, p2y));

        /* ball */
        bx += bdx; by += bdy;
        if (by <= BALL || by >= H - BALL) bdy *= -1;

        /* paddle collision */
        if (bx - BALL <= PAD_W + 12 && by >= p1y && by <= p1y + PAD_H && bdx < 0) {
          bdx = Math.abs(bdx) * 1.05;
          bdy += (by - (p1y + PAD_H/2)) * 0.1;
        }
        if (bx + BALL >= W - PAD_W - 12 && by >= p2y && by <= p2y + PAD_H && bdx > 0) {
          bdx = -Math.abs(bdx) * 1.05;
          bdy += (by - (p2y + PAD_H/2)) * 0.1;
        }

        /* speed cap */
        bdx = Math.max(-8, Math.min(8, bdx));
        bdy = Math.max(-6, Math.min(6, bdy));

        /* score */
        if (bx < 0) { s2++; resetBall(); }
        if (bx > W) { s1++; resetBall(); }

        /* draw */
        gc.fillStyle = "#0a0a10"; gc.fillRect(0, 0, W, H);

        /* center line */
        gc.setLineDash([4, 6]);
        gc.strokeStyle = "rgba(255,255,255,.08)";
        gc.beginPath(); gc.moveTo(W/2, 0); gc.lineTo(W/2, H); gc.stroke();
        gc.setLineDash([]);

        /* paddles */
        gc.fillStyle = "#00ff9d";
        gc.shadowColor = "#00ff9d"; gc.shadowBlur = 10;
        gc.fillRect(10, p1y, PAD_W, PAD_H);
        gc.fillStyle = "#7c5cff";
        gc.shadowColor = "#7c5cff";
        gc.fillRect(W - 10 - PAD_W, p2y, PAD_W, PAD_H);
        gc.shadowBlur = 0;

        /* ball */
        gc.fillStyle = "#fff";
        gc.shadowColor = "#fff"; gc.shadowBlur = 8;
        gc.beginPath(); gc.arc(bx, by, BALL, 0, Math.PI*2); gc.fill();
        gc.shadowBlur = 0;

        /* scores */
        gc.font = "bold 28px 'JetBrains Mono', monospace";
        gc.fillStyle = "rgba(0,255,157,.4)"; gc.textAlign = "center";
        gc.fillText(s1, W/2 - 40, 38);
        gc.fillStyle = "rgba(124,92,255,.4)";
        gc.fillText(s2, W/2 + 40, 38);

        if (s1 >= MAX_SCORE) { endPong("you win! üéâ"); return; }
        if (s2 >= MAX_SCORE) { endPong("CPU wins! better luck next time."); return; }

        pongAnim = requestAnimationFrame(tick);
      }

      function resetBall() {
        bx = W/2; by = H/2;
        bdx = (Math.random() > .5 ? 3 : -3);
        bdy = (Math.random() - .5) * 4;
      }

      let pongAnim;
      function endPong(msg) {
        cancelAnimationFrame(pongAnim);
        document.removeEventListener("keydown", keyDown);
        document.removeEventListener("keyup", keyUp);
        addLines([{ t: "" }, { t: `  ${msg}  final: ${s1} - ${s2}`, c: "green bold" }, { t: "" }]);
        gameActive = false;
        prompt();
      }

      pongAnim = requestAnimationFrame(tick);
    }

    /* ======================== SNAKE ======================== */
    function startSnake() {
      gameActive = true;
      addLines([
        { t: "" },
        { t: "üêç SNAKE ‚Äî eat the food, don't hit yourself!", c: "green bold" },
        { t: "  controls: WASD or arrow keys", c: "dim" },
        { t: "  press Q to quit", c: "dim" },
        { t: "" },
      ]);

      const gameCanvas = document.createElement("canvas");
      const COLS = 25, ROWS = 18, CELL = 14;
      gameCanvas.width = COLS * CELL; gameCanvas.height = ROWS * CELL;
      gameCanvas.style.cssText = "display:block;margin:8px auto;border:1px solid rgba(0,255,157,.3);border-radius:8px;background:#0a0a10;max-width:100%;";
      body.appendChild(gameCanvas);
      body.scrollTop = body.scrollHeight;

      const gc = gameCanvas.getContext("2d");
      let snake = [{ x: 12, y: 9 }, { x: 11, y: 9 }, { x: 10, y: 9 }];
      let dir = { x: 1, y: 0 }, nextDir = { x: 1, y: 0 };
      let food = spawnFood();
      let score = 0, alive = true, snakeAnim;

      function spawnFood() {
        let f;
        do { f = { x: Math.floor(Math.random() * COLS), y: Math.floor(Math.random() * ROWS) }; }
        while (snake.some(s => s.x === f.x && s.y === f.y));
        return f;
      }

      function keyHandler(e) {
        const map = {
          'ArrowUp': {x:0,y:-1}, 'w': {x:0,y:-1},
          'ArrowDown': {x:0,y:1}, 's': {x:0,y:1},
          'ArrowLeft': {x:-1,y:0}, 'a': {x:-1,y:0},
          'ArrowRight': {x:1,y:0}, 'd': {x:1,y:0},
        };
        if (e.key === 'q') { alive = false; return; }
        const nd = map[e.key];
        if (nd && !(nd.x === -dir.x && nd.y === -dir.y)) {
          nextDir = nd;
          e.preventDefault();
        }
        if (['w','a','s','d','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
      }
      document.addEventListener("keydown", keyHandler);

      let lastTick = 0;
      const SPEED = 110;

      function tick(ts) {
        if (!alive) { endSnake(); return; }
        if (ts - lastTick < SPEED) { snakeAnim = requestAnimationFrame(tick); return; }
        lastTick = ts;
        dir = nextDir;

        const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

        /* wall wrap */
        if (head.x < 0) head.x = COLS - 1;
        if (head.x >= COLS) head.x = 0;
        if (head.y < 0) head.y = ROWS - 1;
        if (head.y >= ROWS) head.y = 0;

        /* self collision */
        if (snake.some(s => s.x === head.x && s.y === head.y)) { alive = false; endSnake(); return; }

        snake.unshift(head);
        if (head.x === food.x && head.y === food.y) {
          score++;
          food = spawnFood();
        } else {
          snake.pop();
        }

        draw();
        snakeAnim = requestAnimationFrame(tick);
      }

      function draw() {
        gc.fillStyle = "#0a0a10"; gc.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

        /* grid dots */
        gc.fillStyle = "rgba(255,255,255,.03)";
        for (let x = 0; x < COLS; x++) for (let y = 0; y < ROWS; y++) {
          gc.fillRect(x * CELL + CELL/2, y * CELL + CELL/2, 1, 1);
        }

        /* food */
        gc.fillStyle = "#ff3366";
        gc.shadowColor = "#ff3366"; gc.shadowBlur = 8;
        gc.beginPath();
        gc.arc(food.x * CELL + CELL/2, food.y * CELL + CELL/2, CELL/2 - 1, 0, Math.PI*2);
        gc.fill();
        gc.shadowBlur = 0;

        /* snake */
        for (let i = 0; i < snake.length; i++) {
          const s = snake[i];
          const alpha = 1 - (i / snake.length) * .5;
          gc.fillStyle = i === 0 ? "#00ff9d" : `rgba(0,255,157,${alpha})`;
          if (i === 0) { gc.shadowColor = "#00ff9d"; gc.shadowBlur = 6; }
          gc.fillRect(s.x * CELL + 1, s.y * CELL + 1, CELL - 2, CELL - 2);
          gc.shadowBlur = 0;
        }

        /* score */
        gc.font = "bold 12px 'JetBrains Mono', monospace";
        gc.fillStyle = "rgba(255,255,255,.3)";
        gc.textAlign = "right";
        gc.fillText(`score: ${score}`, gameCanvas.width - 8, 16);
        gc.textAlign = "left";
      }

      function endSnake() {
        cancelAnimationFrame(snakeAnim);
        document.removeEventListener("keydown", keyHandler);
        addLines([{ t: "" }, { t: `  game over! final score: ${score}`, c: "green bold" }, { t: "" }]);
        gameActive = false;
        prompt();
      }

      snakeAnim = requestAnimationFrame(tick);
    }

    /* ======================== MATRIX RAIN ======================== */
    let mCanvas, mCtx, mAnim, mOn = false;
    const mChars = "„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥0123456789ABCDEF";

    function startMatrix() {
      if (mOn) return; mOn = true;
      mCanvas = document.createElement("canvas");
      mCanvas.style.cssText = "position:fixed;inset:0;z-index:9998;cursor:pointer;";
      document.body.appendChild(mCanvas);
      mCtx = mCanvas.getContext("2d");
      mCanvas.width = window.innerWidth; mCanvas.height = window.innerHeight;
      const cols = Math.floor(mCanvas.width / 16);
      const drops = Array(cols).fill(1);
      function draw() {
        mCtx.fillStyle = "rgba(5,5,8,.06)";
        mCtx.fillRect(0, 0, mCanvas.width, mCanvas.height);
        mCtx.fillStyle = "#00ff9d";
        mCtx.font = "14px 'JetBrains Mono', monospace";
        for (let i = 0; i < drops.length; i++) {
          mCtx.globalAlpha = Math.random() * .5 + .4;
          mCtx.fillText(mChars[Math.floor(Math.random() * mChars.length)], i * 16, drops[i] * 16);
          if (drops[i] * 16 > mCanvas.height && Math.random() > .975) drops[i] = 0;
          drops[i]++;
        }
        mCtx.globalAlpha = 1;
        mAnim = requestAnimationFrame(draw);
      }
      draw();
      mCanvas.addEventListener("click", stopMatrix);
    }

    function stopMatrix() {
      if (!mOn) return; mOn = false;
      cancelAnimationFrame(mAnim);
      if (mCanvas) { mCanvas.remove(); mCanvas = null; }
    }
  })();
</script>
</body>
</html>
